var socket=io();function colorUpdate(jscolor){var newColor="#"+jscolor;var squareId=$(jscolor.styleElement).parent().attr("id");$(jscolor.styleElement).parent().css("background-color",newColor);socket.emit("updateSquareColor",{color:newColor,squareId:squareId,roomName:$("#roomName").text()})}var zoomScale=1;var zoomOffset=50;var resizeToggle=false;function makeDraggable(squareClass){if(squareClass==".sq-"+$("#userProf").text()||squareClass==".squareAnon"){$(squareClass).draggable({stack:".square",start:function(event,ui){ui.position.left=0;ui.position.top=0},drag:function(event,ui){var changeLeft=ui.position.left-ui.originalPosition.left;var newLeft=ui.originalPosition.left+changeLeft/zoomScale;var changeTop=ui.position.top-ui.originalPosition.top;var newTop=ui.originalPosition.top+changeTop/zoomScale;ui.position.left=newLeft;ui.position.top=newTop;var squarePos={top:$(this).css("top"),left:$(this).css("left")};var squareZ=$(this).css("z-index");var squareId=$(this).attr("id");socket.emit("updateSquarePos",{pos:squarePos,zIndex:squareZ,squareId:squareId,roomName:$("#roomName").text()})}});$(squareClass).resizable({disabled:true,resize:function(event,ui){var changeWidth=ui.size.width-ui.originalSize.width;var newWidth=ui.originalSize.width+changeWidth/zoomScale;var changeHeight=ui.size.height-ui.originalSize.height;var newHeight=ui.originalSize.height+changeHeight/zoomScale;ui.size.width=newWidth;ui.size.height=newHeight;$(this).css("min-height","1px");var squareWidth=$(this).width();var squareHeight=$(this).height();var squareImgHeight=.8*squareHeight;var squareImgWidth=.8*squareWidth;if($(this).children(".squareImg").attr("src")){$(this).children(".squareImg").height(squareImgHeight);$(this).children(".squareImg").width(squareImgWidth)}var squareId=$(this).attr("id");socket.emit("updateSquareSize",{width:squareWidth,height:squareHeight,imageWidth:squareImgWidth,imageHeight:squareImgHeight,squareId:squareId,roomName:$("#roomName").text()})}});jscolor.installByClassName("jscolor")}}function getUserSqCount(userEmail){var className=".sq-"+userEmail;if(!$(className)){return 0}else{return $(className).length}}$(document).ready(function(){var userTyping=false;var deleteMode=false;socket.emit("joinRoom",{roomName:$("#roomName").text()});socket.emit("loadSquares",{roomName:$("#roomName").text()});socket.on("loadSquares",function(data){data.squares.forEach(function(square){var loadedSquare=$(".squarePrototype").clone(true);loadedSquare.attr("id",square._id).addClass("sq-"+square.owner).addClass("square").css("display","flex").appendTo(".squareContainer");loadedSquare.removeClass("squarePrototype");loadedSquare.css("top",square.pos.top);loadedSquare.css("left",square.pos.left);loadedSquare.css("z-index",square.zIndex);loadedSquare.css("min-height","1px");loadedSquare.width(square.width);loadedSquare.height(square.height);loadedSquare.css("background-color",square.color);loadedSquare.children(".squareText").text(square.text);if(square.imageSrc){loadedSquare.children(".squareImg").attr("src",square.imageSrc);loadedSquare.children(".squareImg").height(.8*square.height);loadedSquare.children(".squareImg").width(.8*square.width)}autosize($(".squareTextEdit"));makeDraggable(".sq-"+square.owner)})});makeDraggable(".squareAnon");$(document).on("keydown",function(e){if(e.which==82){var squareClass=".sq-"+$("#userProf").text();if(resizeToggle){$(squareClass).resizable("option","disabled",true);resizeToggle=false}else{$(squareClass).resizable("option","disabled",false);resizeToggle=true}}});var qPressed=false;$(document).on("keydown",function(e){if(e.which==81&&userTyping==false&&qPressed==false){qPressed=true;$(".squareContainer").velocity({scale:"/=1.2"},500);zoomScale/=1.2;zoomOffset/=1.2}});$(document).on("keyup",function(e){if(e.which==81&&userTyping==false&&qPressed==true){qPressed=false}});var ePressed=false;$(document).on("keydown",function(e){if(e.which==69&&userTyping==false&&ePressed==false){ePressed=true;$(".squareContainer").velocity({scale:"*=1.2"},500);zoomScale*=1.2;zoomOffset*=1.2}});$(document).on("keyup",function(e){if(e.which==69&&userTyping==false&&ePressed==true){ePressed=false}});box=$(".squareContainer"),keysPressed={},distancePerIteration=10;function calculateNewValue(oldValue,keyCode1,keyCode2){if(!userTyping){var newValue=parseInt(oldValue,10)-(keysPressed[keyCode1]?distancePerIteration:0)+(keysPressed[keyCode2]?distancePerIteration:0);return newValue}}$(window).keydown(function(event){keysPressed[event.which]=true});$(window).keyup(function(event){keysPressed[event.which]=false});setInterval(function(){box.css({left:function(index,oldValue){return calculateNewValue(oldValue,68,65)},top:function(index,oldValue){return calculateNewValue(oldValue,83,87)}});mouseX=calculateNewValue(mouseX,65,68);mouseY=calculateNewValue(mouseY,87,83)},20);socket.on("updateSquarePos",function(data){$("#"+data.squareId).css("top",data.pos.top);$("#"+data.squareId).css("left",data.pos.left);$("#"+data.squareId).css("z-index",data.zIndex)});socket.on("updateSquareSize",function(data){$("#"+data.squareId).width(data.width);$("#"+data.squareId).height(data.height);if($("#"+data.squareId).children(".squareImg").attr("src")){$("#"+data.squareId).children(".squareImg").width(data.imageWidth);$("#"+data.squareId).children(".squareImg").height(data.imageHeight)}});socket.on("updateSquareColor",function(data){$("#"+data.squareId).css("background-color",data.color)});socket.on("updateSquareText",function(data){$("#"+data.squareId).children(".squareText").text(data.text)});socket.on("updateSquareImage",function(data){$("#"+data.squareId).children(".squareImg").attr("src",data.imageSrc);$("#"+data.squareId).children(".squareImg").height(.8*$("#"+data.squareId).height());$("#"+data.squareId).children(".squareImg").width(.8*$("#"+data.squareId).width())});socket.on("deleteSquare",function(data){$("#"+data.squareId).remove()});socket.on("deleteAllSquares",function(data){$(".square").remove()});var mouseX=0;var mouseY=0;$(document).mousemove(function(e){var bodyOffsets=document.body.getBoundingClientRect();mouseX=(e.pageX-$(".squareContainer").offset().left-zoomOffset)/zoomScale;mouseY=(e.pageY-$(".squareContainer").offset().top-zoomOffset)/zoomScale});var spam=false;$(document).on("keydown",function(e){if(e.which==32&&userTyping==false){e.preventDefault();if(userTyping==false&&$("#userProf").text()&&!spam){var roomName=$("#roomName").text();socket.emit("newSquare",{user:$("#userProf").text(),roomName:roomName,mouseX:mouseX,mouseY:mouseY});spam=true;setTimeout(function(){spam=false},2e3)}}});socket.on("newSquare",function(data){var userSqCount=getUserSqCount(data.user);var newClass="sq-"+data.user;var newId=data.squareId;var newSquare=$(".squarePrototype").clone(true);newSquare.css("top",data.pos.top);newSquare.css("left",data.pos.left);newSquare.attr("id",newId).addClass(newClass).addClass("square").css("display","flex").appendTo(".squareContainer");newSquare.removeClass("squarePrototype");newSquare.css("min-height","1px");newSquare.css({width:"100px",height:"100px"});newSquare.css("z-index",9e3);autosize($(".squareTextEdit"));makeDraggable("."+newClass)});$(document).on("keydown",function(e){if(e.which==67&&userTyping==false){var squareClass=".sq-"+$("#userProf").text();$(squareClass).children(".color").css("display","block");$(".squareAnon").children(".color").css("display","block")}});$(document).on("keyup",function(e){if(e.which==67){var squareClass=".sq-"+$("#userProf").text();$(squareClass).children(".color").css("display","none");$(".squareAnon").children(".color").css("display","none")}});var showImageEdit=false;$(document).on("keydown",function(e){if(e.which==73&&userTyping==false){var squareClass=".sq-"+$("#userProf").text();if(showImageEdit){$(squareClass).children(".imgEdit").css("display","none");$(squareClass).children(".imgEditBtn").css("display","none");showImageEdit=false}else{$(squareClass).children(".imgEdit").css("display","block");$(squareClass).children(".imgEditBtn").css("display","block");showImageEdit=true}}});$(".imgEditBtn").click(function(){var thisSquare=$(this).parent();thisSquare.children(".squareImg").height(.8*thisSquare.height());thisSquare.children(".squareImg").width(.8*thisSquare.width());thisSquare.children(".squareImg").attr("src",thisSquare.children(".imgEdit").val());var squareClass=".sq-"+$("#userProf").text();$(squareClass).children(".imgEdit").css("display","none");$(squareClass).children(".imgEditBtn").css("display","none");showImageEdit=false;socket.emit("updateSquareImage",{imageSrc:thisSquare.children(".imgEdit").val(),squareId:thisSquare.attr("id"),roomName:$("#roomName").text()})});$(document).on("keydown",function(e){if(e.which==70&&userTyping==false){var squareClass=".sq-"+$("#userProf").text();$(squareClass).css("box-shadow","0px 0px 5px red");$(".squareAnon").css("box-shadow","0px 0px 5px red");deleteMode=true}});$(document).on("keyup",function(e){if(e.which==70){var squareClass=".sq-"+$("#userProf").text();$(squareClass).css("box-shadow","0px 0px 0px");$(".squareAnon").css("box-shadow","0px 0px 0px");deleteMode=false}});$(document).on("click",".square",function(){if(deleteMode&&($(this).hasClass("sq-"+$("#userProf").text())||$(this).hasClass("squareAnon")||$("#userProf").text()=="sqwar")){$(this).remove();var squareId=$(this).attr("id");var roomName=$("#roomName").text();socket.emit("deleteSquare",{squareId:squareId,roomName:roomName,username:$("#userProf").text()})}});var hideOtherSquares=true;$(document).on("keydown",function(e){if(e.which==88&&userTyping==false){var userSquareClass=".sq-"+$("#userProf").text();if(hideOtherSquares){$(".square").not(userSquareClass).css("display","none");hideOtherSquares=false}else{$(".square").not(userSquareClass).css("display","flex");hideOtherSquares=true}}});$(document).on("dblclick",".square",function(){if($(this).hasClass("sq-"+$("#userProf").text())||$(this).hasClass("squareAnon")){var squareText=$(this).children("p");var squareTextEdit=$(this).children("textarea").css("display","block").val(squareText.text());squareText.css("display","none");squareTextEdit.focus();userTyping=true}});$(".squareTextEdit").blur(function(){userTyping=false;var squareTextEditValue=$(this).val();var squareText=$(this).parent().children("p");squareText.css("display","inline-block").text(squareTextEditValue);$(this).css("display","none");var squareId=squareText.parent().attr("id");socket.emit("updateSquareText",{text:squareTextEditValue,squareId:squareId,roomName:$("#roomName").text()})});autosize($(".squareTextEdit"));$(".roomInputBtn").click(function(){var roomInput=$("#roomInput").val()?$("#roomInput").val():"Main";window.location="/room/"+roomInput});var showHints=true;$(document).on("keydown",function(e){if(e.which==72){if(showHints){$(".hintsContainer").css("display","none");showHints=false}else{$(".hintsContainer").css("display","block");showHints=true}}});$("input").focus(function(){userTyping=true});$("input").blur(function(){userTyping=false});$("#register").click(function(){$.post("/register",{username:$("#username").val(),password:$("#password").val()},function(){location.reload()})});$("#login").click(function(){$.post("/login",{username:$("#username").val(),password:$("#password").val()},function(){location.reload()})});$("#logout").click(function(){$.post("/logout",function(req,res){location.reload()})})});